<tool id="mauve-contig-mover" name="Mauve Contig Mover" version="1.0" profile="16.04">
    <requirements>
        <requirement type="package">mauve</requirement>
    </requirements>
    <version_command>mauveAligner --version</version_command>
    <command detect_errors="aggressive"><![CDATA[
        #if $ref_select.ref_source == "db"
            #set $index = $ref_select.ref_db
        #else if $ref_select.ref_source == "meta"
            #set $index = $data.metadata.dbkey
        #else if $ref_select.ref_source == "key"
            #set $index = $ref_select.key
        #else
            #set $index = None
            #set $ref = $ref_select.ref
            #if $ref.is_of_type("genbank")
                ln -sf $ref ${ref}.gbk &&
                #set $ref = $str($ref) + ".gbk"
            #end if
        #end if
        
        #if $index
            ## Get path to database file
            #set $ref = next(record for record in $__app__.tool_data_tables['all_fasta'].get_fields() if str( x[0] ) == str( $index ))[-1]
        #end if

        #if $draft.is_of_type("genbank")
            ln -sf $draft `basename ${draft}.gbk` &&
            #set $draft = $os.path.basename(str($draft)) + ".gbk"
        #end if
        
        MauveCM -output output -ref $ref -draft $draft &&
        ln -sf output/`ls -1 output | tail -n1` final &&
        ln -sf final/`ls -1 -I '*.*' final | tail -n1` final.merged &&
        ln -sf `ls -1 final/*.fas | tail -n1` final.reordered &&
        ln -sf `ls -1 final/*.backbone | tail -n1` final.backbone &&
        ln -sf `ls -1 final/*.tab | tail -n1` final.tab
    ]]></command>
    <inputs>
        <param name="draft" type="data" format="genbank,fasta" label="Draft" />
        <conditional name="ref_select">
            <param name="ref_source" type="select" label="Select the source of the reference to align the draft to">
                <option value="db">Data manager</option>
                <option value="file">History</option>
                <option value="meta" selected="true">Input Metadata</option>
                <option value="key">Key</option>
            </param>
            <when value="file">
                <param name="ref" type="data" format="genbank,fasta" label="Reference" />
            </when>
            <when value="db">
                <param name="ref_db" type="select" label="Using reference genome" help="Select genome from the list">
                    <options from_data_table="all_fasta">
                        <filter type="sort_by" column="2" />
                    </options>
                    <validator type="no_options" message="A built-in reference genome is not available for the build associated with the selected input file"/>
                </param>
            </when>
            <when value="meta">
            </when>
            <when value="key">
                <param name="key" type="text" label="Provide a dbkey to use" />
            </when>
        </conditional>
    </inputs>
    <outputs>
        <data name="fasta" format="fasta" from_work_dir="final.merged" label="${tool.name} on ${on_string}: Reordered FASTA" />
        <data name="reordered" format_source="$draft" from_work_dir="final.reordered" label="${tool.name} on ${on_string}: Reordered" />
        <data name="backbone" format="tabular" from_work_dir="final.backbone" label="${tool.name} on ${on_string}: Backbone" />
        <data name="tab" format="tabular" from_work_dir="final.tab" label="${tool.name} on ${on_string}: Contig Order" />
    </outputs>
</tool>
